<!doctype html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Language Report</title>
    <script src="https://cdn.zinggrid.com/zinggrid.min.js" defer></script>
    <script src="https://cdn.zingchart.com/zingchart.min.js" defer></script>
    <style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
        Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
        margin: 1rem 2rem;
        background: #f9f9f9;
        color: #333;
    }
    h1 {
        font-size: 2.25rem;
        margin-bottom: 0.25rem;
    }
    a {
        color: #2176ff;
        text-decoration: none;
    }
    a:hover {
        text-decoration: underline;
    }
    p.intro {
        font-size: 1.125rem;
        max-width: 720px;
        margin-bottom: 1rem;
    }
    section {
        background: #eee;
        border-radius: 1rem;
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
        padding: 1rem 2rem;
        margin-top: 1.5rem;
        max-width: 960px;
    }
    section > h2 {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
    }
    visual-chart, visual-grid {
        background: #fff;
        border-radius: 1rem;
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.25);
        padding: 1rem;
        margin-top: 1rem;
        display: block;
    }
    /* Provide height for chart and grid blocks */
    visual-chart {
        height: 600px;
    }
    visual-grid {
        height: 500px;
    }
    </style>
</head>

<body>
    <h1><a href="https://annekelley.site/">annekelley.site</a> User Language Report</h1>

    <p class="intro">
    Question: Should we create versions of our webpages in other languages, and serve them based on each userâ€™s native tongue?
    </p>

    <p class="intro">
    According to our collector script, most site visitors speak English, a significant number are Spanish speakers, and only a handful primarily speak French.
    </p>

    <section aria-label="User language distribution" style="max-width:960px; margin-bottom: 1.5rem;">
        <h2>User Language Distribution</h2>
        <p class="intro" style="margin-top:0;">
            Spanish users are a notable percentage among site visitors.
        </p>
        <div id="userLangPie" style="
            background:#fff;
            border-radius:1rem;
            box-shadow:0 0.5rem 1rem rgba(0,0,0,0.25);
            padding:1rem;
            margin-top:1rem;
            width:100%;
            height:380px;
            display:flex;
            align-items:center;
            justify-content:center;
        "></div>
        </section>


    <p class="intro">
    Given that the Spanish speaking group makes up a notable percentage of our overall users, we should consider providing Spanish versions for the popular pages among the Spanish speakers. The following grid displays the pages visited by Spanish speakers, ordered from most to least popular.
    </p>

    <section aria-label="Popular pages visited by Spanish speakers">
        <h2>Spanish Page Visits</h2>
        <!-- Grid container, styled for appearance and used as the grid mounting point -->
        <div id="spanishVisitsGrid" 
            caption="Files to Consider for Spanish Adaptation" 
            style="background: #fff; border-radius: 1rem; box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.25); padding: 1rem; margin-top: 1rem;">
        </div>
    </section>


    <p class="intro">
    As you can see, the error page, member page for Anne Kelley, homepage, and the Perl demos are the most visited among Spanish speakers. Therefore, to improve user experience for this substantial chunk of our visitors, we could create Spanish versions of these pages and redirect Spanish speakers to them in our routing.
    </p>

    <script type="module">
        ZC.LICENSE = ["569d52cefae586f634c54f86dc99e6a9", "b55b025e438fa8a98e32482b5f768ff5"];

        async function renderChart() {
            try {
                const resp = await fetch('/endpoint.php/reports/user-langs');
                const langData = await resp.json();
                // langData ex: [{userLang: "en", count: 10, language: "English"}, ...]

                const pieLabels = langData.map(row => row.language);  // ["English", "Spanish", ...]
                const pieValues = langData.map(row => parseInt(row.count, 10));  // 10 communicates nums are base 10

                const userLangColors = ["#27ae60", "#e74c3c", "#f5cba7", "#7f8c8d", "#16a085"];
                // -- Pie Chart --
                const userLangPie = generatePieConfig(pieLabels, pieValues, 
                "User Language Distribution", "Spanish users are a noteable percentage", 
                {
                    threshold: "15%",
                    others: { text: "Others", backgroundColor: "#2980b9" },
                    slice: 0.6
                }, userLangColors.slice(0,pieValues.length));

                zingchart.render({ id: 'userLangPie', data: JSON.stringify(userLangPie), width: '100%', height: 350 });
            } catch (err) {
                console.error("Error rendering charts:", err);
            }
        }

        /**
         * Generates configuration for a pie chart.
         * @param {Array} labels - Labels for the pie chart.
         * @param {Array} values - Values for each slice.
         * @param {Object} options - Additional options for the pie chart.
         * @param {Array} colors - Specifies the colors for each slice, in the order they are given in values
         * @returns {Object} - Configuration object for the pie chart.
         */
        function generatePieConfig(labels, values, options, colors) {
            return {
                type: 'navpie', // allows for flexibility of representing many small slices effectively
                options,
                plot: {
                    borderColor: "#fff",
                    borderWidth: 2,
                    valueBox: [
                        {
                            placement: 'out',
                            text: '%t\n',
                            fontSize: '14',
                            fontFamily: "Open Sans"
                        },
                    ],
                    tooltip: {
                        fontSize: '14',
                        fontFamily: "Open Sans",
                        padding: "5 10",
                        text: "%npv%<br>Count: %v"
                    }
                },
                series: labels.map((label, i) => ({
                    text: label,
                    values: [values[i]],
                    backgroundColor: colors[i]
                }))
            }
        }

        async function renderGrid() {
            try {
            // Fetch the page views by Spanish speakers (adjust URL as needed)
            const resp = await fetch('/endpoint.php/reports/spanish-pages');
            const data = await resp.json();  // Expected: [{FileName: "index.html", Visits: 803}, ...]

            // Convert Visits fields to numbers to avoid issues
            data.forEach(row => {
                row.Visits = parseInt(row.Visits, 10);
            });

            // Configure ZingGrid
            // We define the columns explicitly to format headers and data types
            const columns = [
                { index: 'FileName', header: 'File Name', sortable: true },
                { index: 'Visits', header: 'Number of Visits', type: 'number', sortable: true }
            ];

            // Create a new ZingGrid with data and configuration
            const grid = document.createElement('zing-grid');
            grid.setAttribute('page-size', '20');
            grid.setAttribute('page-size-options', '10,20,50');
            grid.setAttribute('sort-on-load', 'true');
            grid.setAttribute('sort-column', 'Visits');
            grid.setAttribute('sort-direction', 'desc');
            grid.data = data;
            grid.columns = columns;

            // Append the grid to the container
            const container = document.getElementById('spanishVisitsGrid');
            container.appendChild(grid);

            } catch (error) {
            console.error('Error rendering Spanish Visits Grid:', error);
            }
        }

        renderChart();
        renderGrid();

    </script>
</body>

</html>