<!doctype html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Browsers and Errors Report</title>
    <script src="https://cdn.zinggrid.com/zinggrid.min.js" defer></script>
    <script src="https://cdn.zingchart.com/zingchart.min.js" defer></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
            Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            margin: 1rem 2rem;
            background: #f9f9f9;
            color: #333;
        }
        h1 {
            font-size: 2.25rem;
            margin-bottom: 0.25rem;
        }
        a {
            color: #2176ff;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        section {
            background: #eee;
            border-radius: 1rem;
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
            padding: 2rem 2.5rem;
            margin-top: 2rem;
            max-width: 960px;
            margin-left: auto;
            margin-right: auto;
        }
        section > h2 {
            font-size: 1.5rem;
            margin-bottom: 0.75rem;
        }
        .intro, .section-content {
            font-size: 1.125rem;
            width: 100%;      /* Fills the card horizontally */
            max-width: none;  /* Remove max width restriction */
            margin-bottom: 1rem;
            margin-left: auto;
            margin-right: auto;
        }
        .datacontent {
            padding: 0;
            background: none;
            box-shadow: none;
        }
        .barchart-card {
            display: flex;
            justify-content: center;
            align-items: center;
            background: #fff;
            border-radius: 1rem;
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.10);
            width: 550px;
            height: 400px;
            margin-bottom: 1.5rem;
        }
    </style>
</head>

<body>
    <h1>
        <a href="https://annekelley.site/">annekelley.site</a> Browsers and Errors Report
    </h1>

    <!-- SECTION: Question -->
    <section aria-label="Report Question">
        <h2>Question</h2>
        <div class="section-content">
            Are our users experiencing errors as a result of us not supporting enough browser types?
        </div>
    </section>

    <!-- SECTION: Data -->
    <section aria-label="Brower Data" class="datacontent">
        <h2>Data</h2>
        <div class="section-content">

        </div>
        <!-- User Language Pie Chart Card -->
        <div class="barchart-card">
            <div id="userAgentBar" style="width: 800px; height: 400px;"></div>
        </div>

    </section>

    <!-- SECTION: Exploration -->
    <section aria-label="Data Exploration">
        <h2>Exploration</h2>
        <div class="section-content">

        </div>
        <!-- Data grid card below -->
        <div style="background: #fff; border-radius: 1rem; box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.25); padding: 1rem; margin-top: 1rem;">
            <h3 style="margin-top: 0;">Pages to Consider for Spanish Adaptation</h3>
            <div id="spanishVisitsGrid" style="width: 100%;"></div>
        </div>
    </section>

    <!-- SECTION: Action -->
    <section aria-label="Recommended Action">
        <h2>Action</h2>
        <div class="section-content">

        </div>
    </section>

    <script type="module">
        ZC.LICENSE = ["569d52cefae586f634c54f86dc99e6a9", "b55b025e438fa8a98e32482b5f768ff5"];

        async function renderChart() {
            try {
                const resp = await fetch('/endpoint.php/reports/browser-types');
                const userAgentData = await resp.json();

                const browsers = ["Chrome", "Safari", "Firefox"];
                const platforms = ["Windows", "Mac", "iOS", "Linux"];

                // Builds a dictionary for aggregation
                const agg = {};
                // Initializes for each platform, each browser
                platforms.forEach(platform => {
                    agg[platform] = {};
                    browsers.forEach(browser => agg[platform][browser] = 0);
                });

                // Uses count now, not fraction
                userAgentData.forEach(row => {
                    agg[row.platform][row.browser] += parseInt(row.count, 10);  // parseInt for counts
                });

                // Assigns colors by platform
                const platformColors = {
                    Windows: "#377eb8",
                    Mac: "#4daf4a",
                    iOS: "#e41a1c",
                    Linux: "#984ea3"
                };

                const series = platforms.map(platform => ({
                    text: platform,
                    backgroundColor: platformColors[platform] || "#999",
                    values: browsers.map(browser => agg[platform][browser])
                }));

                const barData = {
                    type: "bar",
                    stacked: true,
                    legend: { align: "center", verticalAlign: "bottom" },
                    scaleX: { labels: browsers },
                    scaleY: { label: { text: "Number of Users" } },  // Label changed from Fraction
                    series: series
                };
                zingchart.render({ id: 'userAgentBar', data: barData, width: 700, height: 400 });
            } catch (err) {
                console.error("Error rendering charts:", err);
            }
        }

        async function renderGrid() {
            try {
                const resp = await fetch('/endpoint.php/reports/spanish-pages');
                const data = await resp.json();
                data.forEach(row => { row.Visits = parseInt(row.Visits, 10); });
                const columns = [
                    { index: 'FileName', header: 'File Name', sortable: true },
                    { index: 'Visits', header: 'Total Number of Visits', type: 'number', sortable: true }
                ];
                const grid = document.createElement('zing-grid');
                grid.setAttribute('page-size', '20');
                grid.setAttribute('page-size-options', '10,20,50');
                grid.setAttribute('sort-on-load', 'true');
                grid.setAttribute('sort-column', 'Visits');
                grid.setAttribute('sort-direction', 'desc');
                grid.data = data;
                grid.columns = columns;
                document.getElementById('spanishVisitsGrid').appendChild(grid);
            } catch (error) {
                console.error('Error rendering Spanish Visits Grid:', error);
            }
        }
        renderChart();
        renderGrid();
    </script>
</body>
</html>