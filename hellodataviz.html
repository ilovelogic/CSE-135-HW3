<!doctype html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Visuals</title>
    <script src="https://cdn.zingchart.com/zingchart.min.js"></script>
</head>

<body>
    <!-- ZingChart -->
    <div id="charts">
        <!-- <div id="bar3"></div> -->
        <div id="bar2"></div>
        <div id="pie"></div>
    </div>
    <script>
        async function getData(resource, colNames) {
            let url = "/api.php";

            if (resource == "static") {
                url += "/static";
            }
            else if (resource == "performance") {
                url += "/performance";
            }
            else if (resource == "activity") {
                url += "/activity";
            }
            else {
                // send an error message
            }

            // path will be /api.php/{resource}/{col_1}&{col_2}&...&{col_n}
            if (colNames.length != 0) {
                url += "/";
                let lastIndex = colNames.length - 1;
                for (let i = 0; i < lastIndex; i++) {
                    url += colNames[i] + "&"; // & purely for purposes of debugging, php api would work fine without it
                    // since we are using strpos and no colName is a subset of another colName
                }
                url += colNames[lastIndex];
            }

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Response status: ${response.status}`);
                }

                const result = await response.json();
                console.log(result);
                return result;
            } catch (error) {
                console.error(error.message);
            }
        }

        ZC.LICENSE = ["569d52cefae586f634c54f86dc99e6a9", "b55b025e438fa8a98e32482b5f768ff5"];

        async function renderCharts() {
            try {
                // Dynamic fetch of data
                const rawStaticData = await getData('static', 
                ['userScreenWidth', 'userWindowWidth', 'userWindowHeight', 'acceptsCookies', 'userNetConnType']);
                
                console.log("Fetched static data:", rawStaticData);

                // Aggregate counts
                const pieCounts = {};
                const bar2AC1Counts = {}; // network type counts where acceptsCookies is true
                const bar2AC0Counts = {}; // network type counts where acceptsCookies is false
                //const bar3Counts = {};

                rawStaticData.forEach(item => {
                    // Pie chart labels and values
                    const uSW = item.userScreenWidth;
                    pieCounts[uSW] = (pieCounts[uSW] || 0) + 1;

                    // 2 series bar chart lables and values
                    // comparing users who accept cookies with those who do not
                    // in terms of their network connection
                    const aC = item.acceptsCookies;
                    const uNCT = item.userNetConnType;

                    if (aC === true) { // user accepts cookies
                        bar2AC1Counts[uNCT] = (bar2AC1Counts[uNCT] || 0) + 1;
                    }
                    else { // user rejects cookies
                        bar2AC0Counts[uNCT] = (bar2AC1Counts[uNCT] || 0) + 1;
                    }

                    /* 3 series bar chart lables and values
                    // comparing 3 groups of user window width in terms of their window height
                    const uWW = item.userWindowWidth;
                    const uWH = item.userWindowHeight;
                    bar3Counts[uWW] = (bar2Counts[uWW] || 0) + 1;
                    bar3Counts[uWH] = (bar2Counts[uWH] || 0) + 1;
                    */
                });

                // Convert to arrays
                const pieLabels = Object.keys(pieCounts);
                const pieValues = Object.values(pieCounts);

                const bar2Labels = Object.keys(bar2AC0Counts); // either AC0 or AC1 would work here

                const bar2AC0Values = Object.values(bar2AC0Counts);
                const bar2AC1Values = Object.values(bar2AC1Counts);

                /* --- 3-Series Bar Chart ---
                const bar3Config = {
                    type: 'bar',
                    title: { text: '3-Series Bar Chart Example' },
                    scaleX: { pieLabels },
                    series: [
                        { pieValues },                                // actual counts
                        { values: pieValues.map(v => v * 2) },        // example transformation
                        { values: pieValues.map(v => v + 1) }         // example transformation
                    ]
                }; */

                // --- 2-Series Bar Chart ---
                const bar2Config = {
                    type: 'bar',
                    title: { text: 'Accepting Cookies vs. Network Connectivity' },
                    scaleX: { bar2Labels },

                    series: [
                        {
                            values: bar2AC0Counts,
                            text: "Rejects Cookies"
                        },
                        {
                            values: bar2AC1Counts,
                            text: "Accepts Cookies"
                        }
                    ]
                };

                // --- Pie Chart ---
                const pieConfig = {
                    type: 'pie',
                    title: { text: 'Screen Width Distribution' },
                    options: { 
                        threshold: "10%", // slices smaller than %10 are grouped into the "others" slice
                        others: {
                            text: "Other Connections",
                            backgroundColor: "#999 #333"
                        },
                        slice: 0.65, // "slice out" amount of focused (selected) pie slide, 65% of radius
                    },
                    plot: {
                        borderColor: "#fff", // white
                        borderWidth: 2,
                        valueBox: [
                            {
                                placement: 'out',
                                text: '%t\n',
                                fontSize: '14',
                                fontFamily: "Open Sans"
                            },
                        ],
                        tooltip: {
                            fontSize: '14',
                            fontFamily: "Open Sans",
                            padding: "5 10",
                            text: "%npv%<br>Count: %v"
                        },
                    },
                    series: pieLabels.map((label, i) => ({
                        text: label,
                        values: [pieValues[i]]
                    }))
                };
                

                // Render
                //zingchart.render({ id: 'bar3', data: bar3Config, height: 400, width: '100%' });
                // zingchart.render({ id: 'bar2', data: bar2Config, height: 400, width: '100%' });
                zingchart.render({ id: 'pie', data: pieConfig, height: 400, width: '100%' });

            } catch (err) {
                console.error("Error rendering charts:", err);
            }
        }

        renderCharts();
    </script>
</body>

</html>